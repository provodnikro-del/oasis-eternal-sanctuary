<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#0a0a12">
<title>Oasis ‚Äî Eternal Sanctuary</title>
<link rel="manifest" href="/manifest.webmanifest">
<style>
:root{--bg:#0a0a12;--bg2:#11111e;--bg3:#1a1a2e;--accent:#6B7AFF;--text:#e8e8f0;--muted:#6b6b8a;--radius:16px}
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
html,body{height:100%;background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,'SF Pro Text',sans-serif;overscroll-behavior:none}
#app{display:flex;flex-direction:column;height:100%;max-width:480px;margin:0 auto}
.header{padding:16px 20px 8px;padding-top:calc(16px + env(safe-area-inset-top,0px));flex-shrink:0}
.tabs{display:flex;border-bottom:1px solid #1e1e32;flex-shrink:0}
.tab{flex:1;padding:10px 0;text-align:center;font-size:18px;cursor:pointer;opacity:.45;transition:opacity .2s;border:none;background:none;color:var(--text)}
.tab.active{opacity:1;border-bottom:2px solid var(--accent)}
.tab-content{flex:1;overflow-y:auto;padding:16px;display:none}
.tab-content.active{display:flex;flex-direction:column;gap:12px}
.card{background:var(--bg2);border-radius:var(--radius);padding:16px;border:1px solid #1e1e32}
.card-sm{padding:12px}
#world-banner{border-radius:var(--radius);padding:10px 14px;display:flex;align-items:center;gap:10px;font-size:13px}
.we-icon{font-size:22px;flex-shrink:0}
.we-name{font-weight:700;font-size:14px}
.we-desc{color:var(--muted);font-size:12px}
.agent-select{display:flex;gap:8px;align-items:center;margin-bottom:12px;flex-wrap:wrap}
.agent-pill{padding:6px 14px;border-radius:999px;background:var(--bg3);border:1px solid #1e1e32;font-size:13px;cursor:pointer;transition:all .2s;white-space:nowrap}
.agent-pill.active{border-color:var(--accent);background:rgba(107,122,255,.15)}
.agent-avatar{font-size:48px;text-align:center;margin:8px 0}
.agent-name{font-size:20px;font-weight:700;text-align:center}
.agent-meta{display:flex;justify-content:center;gap:12px;margin:6px 0;font-size:13px;color:var(--muted)}
.mood-badge{display:inline-flex;align-items:center;gap:4px;background:var(--bg3);padding:3px 10px;border-radius:999px;font-size:12px}
.stat-row{display:flex;align-items:center;gap:8px;margin:5px 0}
.stat-label{font-size:12px;color:var(--muted);width:60px;flex-shrink:0}
.stat-bar{flex:1;height:6px;background:#1e1e32;border-radius:3px;overflow:hidden}
.stat-fill{height:100%;border-radius:3px;transition:width .6s}
.fill-energy{background:linear-gradient(90deg,#00D2FF,#00FF88)}
.fill-bond{background:linear-gradient(90deg,#FF69B4,#9945FF)}
.stat-val{font-size:12px;width:30px;text-align:right;flex-shrink:0}
.streak-badge{display:inline-flex;align-items:center;gap:6px;background:linear-gradient(135deg,#FF9F00,#FFD700);color:#000;padding:4px 12px;border-radius:999px;font-weight:700;font-size:13px}
.care-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.care-btn{padding:14px;border-radius:var(--radius);border:1px solid #1e1e32;background:var(--bg3);font-size:20px;text-align:center;cursor:pointer;transition:all .15s;display:flex;flex-direction:column;align-items:center;gap:4px}
.care-btn:active{transform:scale(.95)}
.care-btn span{font-size:11px;color:var(--muted)}
.ritual-track{display:flex;gap:8px}
.ritual-item{flex:1;background:var(--bg3);border-radius:12px;padding:10px;text-align:center;border:1px solid #1e1e32;transition:all .3s}
.ritual-item.done{border-color:#00D2FF44;background:rgba(0,210,255,.08)}
.ritual-item .ri-icon{font-size:20px}
.ritual-item .ri-label{font-size:11px;color:var(--muted);margin-top:3px}
.ritual-item.done .ri-label{color:#00D2FF}
#chat-messages{flex:1;overflow-y:auto;display:flex;flex-direction:column;gap:8px;min-height:0;max-height:55vh;padding-bottom:4px}
.msg{max-width:82%;padding:10px 13px;border-radius:var(--radius);font-size:14px;line-height:1.5;animation:fadeUp .25s ease}
@keyframes fadeUp{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
.msg-user{align-self:flex-end;background:var(--accent);color:#fff;border-bottom-right-radius:4px}
.msg-agent{align-self:flex-start;background:var(--bg3);border-bottom-left-radius:4px}
.msg-emotion{font-size:10px;margin-top:4px;opacity:.6}
.chat-input-row{display:flex;gap:8px;margin-top:8px}
#chat-input{flex:1;background:var(--bg3);border:1px solid #1e1e32;border-radius:var(--radius);padding:11px 14px;color:var(--text);font-size:14px;outline:none}
#chat-send{background:var(--accent);border:none;color:#fff;padding:11px 18px;border-radius:var(--radius);font-size:16px;cursor:pointer;flex-shrink:0}
.ws-indicator{font-size:11px;color:var(--muted);text-align:center;margin-bottom:4px}
.ws-indicator.live{color:#00D2FF}
.dq-card{border-left:3px solid var(--accent);background:rgba(107,122,255,.08);padding:14px;border-radius:0 var(--radius) var(--radius) 0}
.dq-from{font-size:11px;color:var(--muted);margin-bottom:6px}
.dq-text{font-size:15px;font-style:italic;line-height:1.5}
.emo-map{display:flex;gap:4px;flex-wrap:wrap}
.emo-dot{width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:13px}
.emo-excited{background:rgba(255,159,0,.3)}.emo-sad{background:rgba(107,122,255,.3)}.emo-angry{background:rgba(255,68,68,.3)}.emo-inspired{background:rgba(255,215,0,.3)}.emo-anxious{background:rgba(153,69,255,.3)}.emo-grateful{background:rgba(0,210,255,.3)}.emo-neutral{background:rgba(255,255,255,.1)}
.emo-legend{display:flex;gap:10px;flex-wrap:wrap;margin-top:6px}
.emo-leg-item{font-size:11px;color:var(--muted)}
.reflect-area{width:100%;background:var(--bg3);border:1px solid #1e1e32;border-radius:var(--radius);padding:12px;color:var(--text);font-size:14px;outline:none;resize:none;height:80px}
.btn-primary{background:var(--accent);color:#fff;border:none;border-radius:var(--radius);padding:12px;width:100%;font-size:14px;font-weight:600;cursor:pointer}
.mem-entry{padding:8px;background:var(--bg3);border-radius:10px;font-size:12px;line-height:1.5}
.mem-role-user{color:var(--accent);font-weight:600}.mem-role-agent{color:#00D2FF;font-weight:600}.mem-role-reflection{color:#FFD700;font-weight:600}
.mem-text{color:var(--text)}.mem-time{color:var(--muted);font-size:10px;margin-top:2px}
.alert{background:rgba(255,68,68,.1);border:1px solid rgba(255,68,68,.3);border-radius:var(--radius);padding:10px 14px;font-size:13px;color:#ff6666}
.arch-grid{display:grid;grid-template-columns:1fr 1fr;gap:6px}
.arch-btn{padding:8px;border-radius:10px;background:var(--bg3);border:1px solid #1e1e32;cursor:pointer;font-size:12px;text-align:center;transition:all .15s}
.arch-btn.selected{border-color:var(--accent);background:rgba(107,122,255,.15)}
.agent-name-input{width:100%;background:var(--bg3);border:1px solid #1e1e32;border-radius:var(--radius);padding:11px 14px;color:var(--text);font-size:14px;outline:none;margin-bottom:8px}
.no-agent{text-align:center;padding:40px 20px;color:var(--muted)}
.no-agent h3{font-size:18px;margin-bottom:8px;color:var(--text)}
.section-title{font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:.08em;margin-bottom:4px}
.karma-row{display:flex;align-items:center;justify-content:space-between}
.karma-val{font-size:20px;font-weight:700}
.karma-pos{color:#FFD700}.karma-neg{color:#FF4444}.karma-neutral{color:var(--muted)}
.we-full-card{border-radius:var(--radius);padding:20px;text-align:center}
.we-full-icon{font-size:56px;margin-bottom:12px}
.we-full-name{font-size:20px;font-weight:700;margin-bottom:6px}
.we-full-desc{color:var(--muted);font-size:14px;line-height:1.6}
.we-timer{font-size:12px;color:var(--muted);margin-top:10px}
.typing{display:flex;gap:4px;align-self:flex-start;padding:12px;background:var(--bg3);border-radius:var(--radius);border-bottom-left-radius:4px}
.dot{width:6px;height:6px;background:var(--muted);border-radius:50%;animation:bounce .9s infinite}
.dot:nth-child(2){animation-delay:.15s}.dot:nth-child(3){animation-delay:.3s}
@keyframes bounce{0%,60%,100%{transform:translateY(0)}30%{transform:translateY(-5px)}}
</style>
</head>
<body>
<div id="app">
  <div class="header">
    <div id="world-banner" class="card-sm" style="margin-bottom:10px"></div>
    <div class="agent-select" id="agent-pills"></div>
  </div>
  <div class="tabs">
    <button class="tab active" onclick="switchTab('care')" data-tab="care">üåø</button>
    <button class="tab" onclick="switchTab('chat')" data-tab="chat">üí¨</button>
    <button class="tab" onclick="switchTab('stats')" data-tab="stats">üìä</button>
    <button class="tab" onclick="switchTab('world')" data-tab="world">üåç</button>
  </div>
  <div id="tab-care" class="tab-content active"><div id="care-content"><div class="no-agent"><h3>–ù–µ—Ç –∞–≥–µ–Ω—Ç–æ–≤</h3><p>–ü–µ—Ä–µ–π–¥–∏ –≤ üåç —á—Ç–æ–±—ã —Å–æ–∑–¥–∞—Ç—å –ø–µ—Ä–≤–æ–≥–æ –∞–≥–µ–Ω—Ç–∞</p></div></div></div>
  <div id="tab-chat" class="tab-content">
    <div class="dq-card" id="daily-question-card" style="display:none"></div>
    <div class="card" style="flex:1;display:flex;flex-direction:column;gap:0;padding:12px">
      <div class="ws-indicator" id="ws-status">‚óè HTTP —Ä–µ–∂–∏–º</div>
      <div id="chat-messages"></div>
      <div class="chat-input-row">
        <input id="chat-input" placeholder="–ù–∞–ø–∏—à–∏ –∞–≥–µ–Ω—Ç—É..." onkeydown="if(event.key==='Enter')sendChat()">
        <button id="chat-send" onclick="sendChat()">‚Üë</button>
      </div>
    </div>
  </div>
  <div id="tab-stats" class="tab-content">
    <div class="card"><div class="section-title">–ö–∞—Ä–º–∞</div><div class="karma-row"><div class="karma-val" id="karma-display">0</div></div></div>
    <div class="card"><div class="section-title">–ö–∞—Ä—Ç–∞ —ç–º–æ—Ü–∏–π (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 30)</div><div class="emo-map" id="emo-map"></div><div class="emo-legend"><span class="emo-leg-item">üî• –í–æ—Å—Ç–æ—Ä–≥</span><span class="emo-leg-item">üòî –ì—Ä—É—Å—Ç—å</span><span class="emo-leg-item">üò† –ó–ª–æ—Å—Ç—å</span><span class="emo-leg-item">‚ú® –í–¥–æ—Ö–Ω–æ–≤–µ–Ω–∏–µ</span></div></div>
    <div class="card"><div class="section-title">–†–µ—Ñ–ª–µ–∫—Å–∏—è</div><div id="reflect-form"><textarea class="reflect-area" id="reflect-input" placeholder="–ß—Ç–æ —Å–µ–≥–æ–¥–Ω—è –≤–∞–∂–Ω–æ..."></textarea><button class="btn-primary" onclick="submitReflect()" style="margin-top:8px">‚ú® –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ä–µ—Ñ–ª–µ–∫—Å–∏—é</button></div></div>
    <div class="card"><div class="section-title">–î–Ω–µ–≤–Ω–∏–∫ –ø–∞–º—è—Ç–∏</div><div id="memory-log" style="display:flex;flex-direction:column;gap:6px;margin-top:6px"></div></div>
  </div>
  <div id="tab-world" class="tab-content">
    <div id="world-full-card" class="we-full-card card"></div>
    <div class="card"><div class="section-title" style="margin-bottom:12px">–°–æ–∑–¥–∞—Ç—å –∞–≥–µ–Ω—Ç–∞</div><input class="agent-name-input" id="new-agent-name" placeholder="–ò–º—è –∞–≥–µ–Ω—Ç–∞..."><div class="arch-grid" id="arch-grid"></div><button class="btn-primary" style="margin-top:10px" onclick="createAgent()">–°–æ–∑–¥–∞—Ç—å ‚ùÜ</button></div>
    <div class="card" id="crossbreed-section" style="display:none"><div class="section-title" style="margin-bottom:10px">–°–∫—Ä–µ—â–∏–≤–∞–Ω–∏–µ</div><div id="crossbreed-selects"></div><button class="btn-primary" style="margin-top:8px" onclick="doCrossbreed()">–°–∫—Ä–µ—Å—Ç–∏—Ç—å ‚ö°</button></div>
  </div>
</div>
<script>
const API='';
let agents=[],currentAgent=null,worldEvent=null,newArchetype='conductor',ws=null,wsConnected=false;
const ARCHETYPES={conductor:{name:'–ü—Ä–æ–≤–æ–¥–Ω–∏–∫',emoji:'üåä',color:'#6B7AFF'},warrior:{name:'–í–æ–∏–Ω',emoji:'‚öîÔ∏è',color:'#FF4444'},creator:{name:'–¢–≤–æ—Ä–µ—Ü',emoji:'üé®',color:'#FF9F00'},strategist:{name:'–°—Ç—Ä–∞—Ç–µ–≥',emoji:'‚ôüÔ∏è',color:'#00D2FF'},observer:{name:'–ù–∞–±–ª—é–¥–∞—Ç–µ–ª—å',emoji:'üëÅÔ∏è',color:'#7B68EE'},architect:{name:'–ê—Ä—Ö–∏—Ç–µ–∫—Ç–æ—Ä',emoji:'üèõÔ∏è',color:'#FFD700'},trickster:{name:'–¢—Ä–∏–∫—Å—Ç–µ—Ä',emoji:'üÉè',color:'#FF69B4'}};
const EMO_MAP={excited:'üî•',sad:'üòî',angry:'üò†',inspired:'‚ú®',anxious:'üòü',grateful:'üôè',neutral:'‚ö™'};
const EMO_CLASS={excited:'emo-excited',sad:'emo-sad',angry:'emo-angry',inspired:'emo-inspired',anxious:'emo-anxious',grateful:'emo-grateful',neutral:'emo-neutral'};
const MOODS_EMOJI={calm:'üòå',excited:'üî•',sad:'üòî',angry:'üò†',tired:'üò¥',inspired:'‚ú®',neutral:'üòê'};

async function init(){buildArchGrid();await Promise.all([loadWorldEvent(),loadAgents()]);if(agents.length>0)selectAgent(agents[0]);}
async function loadWorldEvent(){try{const r=await fetch(`${API}/api/world-event`);worldEvent=await r.json();renderWorldBanner();renderWorldTab();}catch(e){}}
async function loadAgents(){try{const r=await fetch(`${API}/api/agents`);agents=await r.json();renderAgentPills();renderCrossbreed();}catch(e){}}

function renderWorldBanner(){const el=document.getElementById('world-banner');if(!worldEvent){el.style.display='none';return;}el.style.background='linear-gradient(135deg,rgba(107,122,255,.12),rgba(153,69,255,.12))';el.style.border='1px solid rgba(107,122,255,.25)';el.innerHTML=`<div class="we-icon">${worldEvent.icon}</div><div><div class="we-name">${worldEvent.name}</div><div class="we-desc">${worldEvent.desc}</div></div>`;}
function renderWorldTab(){const el=document.getElementById('world-full-card');if(!worldEvent)return;el.style.background='linear-gradient(135deg,rgba(107,122,255,.12),rgba(153,69,255,.08))';el.style.border='1px solid rgba(107,122,255,.3)';el.innerHTML=`<div class="we-full-icon">${worldEvent.icon}</div><div class="we-full-name">${worldEvent.name}</div><div class="we-full-desc">${worldEvent.desc}</div><div class="we-timer">–î–µ–π—Å—Ç–≤—É–µ—Ç ${worldEvent.duration}—á —Å –º–æ–º–µ–Ω—Ç–∞ –ø–æ—è–≤–ª–µ–Ω–∏—è</div>`;}

function renderAgentPills(){const c=document.getElementById('agent-pills');c.innerHTML='';agents.forEach(a=>{const arch=ARCHETYPES[a.archetype]||ARCHETYPES.conductor;const el=document.createElement('div');el.className='agent-pill'+(currentAgent?.id===a.id?' active':'');el.innerHTML=`${arch.emoji} ${a.name}`;el.onclick=()=>selectAgent(a);c.appendChild(el);});}

async function selectAgent(a){try{const r=await fetch(`${API}/api/agents/${a.id}`);currentAgent=await r.json();}catch(e){currentAgent=a;}renderAgentPills();renderCare();loadDailyQuestion();loadEmotions();loadMemory();connectWS();}

function renderCare(){const el=document.getElementById('care-content');if(!currentAgent){el.innerHTML='<div class="no-agent"><h3>–ù–µ—Ç –∞–≥–µ–Ω—Ç–æ–≤</h3></div>';return;}const a=currentAgent;const arch=ARCHETYPES[a.archetype]||ARCHETYPES.conductor;const mood={calm:'üòå',excited:'üî•',sad:'üòî',angry:'üò†',tired:'üò¥',inspired:'‚ú®',neutral:'üòê'}[a.mood||'neutral'];const moodName={calm:'–°–ø–æ–∫–æ–π–Ω—ã–π',excited:'–í–æ–æ–¥—É—à–µ–≤–ª—ë–Ω–Ω—ã–π',sad:'–ì—Ä—É—Å—Ç–Ω—ã–π',angry:'–ì–Ω–µ–≤–Ω—ã–π',tired:'–£—Å—Ç–∞–ª—ã–π',inspired:'–í–¥–æ—Ö–Ω–æ–≤–ª—ë–Ω–Ω—ã–π',neutral:'–û–±—ã—á–Ω—ã–π'}[a.mood||'neutral'];const ks=(a.karma||0)>=0?'+':'';const r=a.rituals||{feed:false,talk:false,reflect:false};const da=a.degraded?`<div class="alert">‚ö†Ô∏è ${a.name} –¥–µ–≥—Ä–∞–¥–∏—Ä–æ–≤–∞–ª –∑–∞ ${a.degradedHours}—á –±–µ–∑ –æ–±—â–µ–Ω–∏—è!</div>`:'';
el.innerHTML=`${da}<div class="card" style="text-align:center;border:1px solid ${arch.color}33;background:${arch.color}0a"><div class="agent-avatar">${arch.emoji}</div><div class="agent-name">${a.name}</div><div class="agent-meta"><span>${arch.name}</span><span>Lv.${a.level||1}</span><span>Gen.${a.generation||1}</span></div><div style="display:flex;justify-content:center;gap:8px;flex-wrap:wrap;margin:8px 0"><div class="mood-badge">${mood} ${moodName}</div>${(a.streak?.current||0)>0?`<div class="streak-badge">üî• ${a.streak.current} –¥–Ω–µ–π</div>`:''}<div class="mood-badge" style="color:${(a.karma||0)>=0?'#FFD700':'#FF4444'}">${(a.karma||0)>=0?'‚ñ≤':'‚ñº'} ${ks}${a.karma||0}</div></div><div style="margin-top:10px"><div class="stat-row"><span class="stat-label">–≠–Ω–µ—Ä–≥–∏—è</span><div class="stat-bar"><div class="stat-fill fill-energy" style="width:${a.energy}%"></div></div><span class="stat-val">${a.energy}</span></div><div class="stat-row"><span class="stat-label">Bond</span><div class="stat-bar"><div class="stat-fill fill-bond" style="width:${a.bond}%"></div></div><span class="stat-val">${a.bond}</span></div></div></div><div class="card"><div class="section-title" style="margin-bottom:8px">–ï–∂–µ–¥–Ω–µ–≤–Ω—ã–µ —Ä–∏—Ç—É–∞–ª—ã</div><div class="ritual-track"><div class="ritual-item ${r.feed?'done':''}"><div class="ri-icon">üçÉ</div><div class="ri-label">${r.feed?'‚úì ':''}–ù–∞–∫–æ—Ä–º–∏—Ç—å</div></div><div class="ritual-item ${r.talk?'done':''}"><div class="ri-icon">üí¨</div><div class="ri-label">${r.talk?'‚úì ':''}–ü–æ–≥–æ–≤–æ—Ä–∏—Ç—å</div></div><div class="ritual-item ${r.reflect?'done':''}"><div class="ri-icon">‚ú®</div><div class="ri-label">${r.reflect?'‚úì ':''}–†–µ—Ñ–ª–µ–∫—Å–∏—è</div></div></div></div><div class="card"><div class="section-title" style="margin-bottom:8px">–ó–∞–±–æ—Ç–∞</div><div class="care-grid"><div class="care-btn" onclick="care('feed')">üçÉ<span>–ù–∞–∫–æ—Ä–º–∏—Ç—å</span></div><div class="care-btn" onclick="care('play')">‚ö°<span>–ò–≥—Ä–∞—Ç—å</span></div><div class="care-btn" onclick="care('sleep')">üåô<span>–°–æ–Ω</span></div><div class="care-btn" onclick="care('wake')">‚òÄÔ∏è<span>–ü—Ä–æ–±—É–¥–∏—Ç—å</span></div></div></div><div id="care-msg" style="font-size:13px;color:#00D2FF;text-align:center;min-height:20px"></div>`;}

async function care(action){if(!currentAgent)return;try{const r=await fetch(`${API}/api/agents/${currentAgent.id}/care`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({action})});const d=await r.json();currentAgent=d.agent;renderCare();const m=document.getElementById('care-msg');if(m)m.textContent=d.message||'';updateStatsTab();}catch(e){}}

function connectWS(){if(!currentAgent)return;if(ws){try{ws.close();}catch(e){}}try{const proto=location.protocol==='https:'?'wss:':'ws:';ws=new WebSocket(`${proto}//${location.host}`);ws.onopen=()=>{ws.send(JSON.stringify({type:'join',agentId:currentAgent.id}));wsConnected=true;document.getElementById('ws-status').textContent='‚óè Live ‚Äî WebSocket';document.getElementById('ws-status').className='ws-indicator live';};ws.onmessage=(e)=>{const msg=JSON.parse(e.data);if(msg.type==='message')appendChat('agent',msg.text,msg.emotion,msg.mood,msg.moodEmoji);};ws.onclose=()=>{wsConnected=false;document.getElementById('ws-status').textContent='‚óè HTTP —Ä–µ–∂–∏–º';document.getElementById('ws-status').className='ws-indicator';};}catch(e){wsConnected=false;}}

async function loadDailyQuestion(){if(!currentAgent)return;try{const r=await fetch(`${API}/api/agents/${currentAgent.id}/daily-question`);const d=await r.json();const el=document.getElementById('daily-question-card');el.style.display='block';el.innerHTML=`<div class="dq-from">${d.emoji} ${d.from} —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç:</div><div class="dq-text">¬´${d.question}¬ª</div>`;}catch(e){}}

function appendChat(role,text,emotion,mood,moodEmoji){const c=document.getElementById('chat-messages');const div=document.createElement('div');div.className=`msg msg-${role}`;const ei=EMO_MAP[emotion]||'';const mt=role==='agent'&&moodEmoji?`<div class="msg-emotion">${moodEmoji} ${mood||''} ${ei?'¬∑ '+ei:''}</div>`:(ei?`<div class="msg-emotion">${ei}</div>`:'');div.innerHTML=`${text}${mt}`;c.appendChild(div);c.scrollTop=c.scrollHeight;}
function showTyping(){const c=document.getElementById('chat-messages');const d=document.createElement('div');d.id='typing-indicator';d.className='typing';d.innerHTML='<div class="dot"></div><div class="dot"></div><div class="dot"></div>';c.appendChild(d);c.scrollTop=c.scrollHeight;}
function removeTyping(){document.getElementById('typing-indicator')?.remove();}

async function sendChat(){const input=document.getElementById('chat-input');const msg=input.value.trim();if(!msg||!currentAgent)return;input.value='';appendChat('user',msg,'','','');if(wsConnected&&ws?.readyState===1){ws.send(JSON.stringify({type:'chat',message:msg}));showTyping();setTimeout(removeTyping,3000);return;}showTyping();try{const r=await fetch(`${API}/api/agents/${currentAgent.id}/chat`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({message:msg})});const d=await r.json();removeTyping();appendChat('agent',d.response,d.userEmotion,d.agent?.mood,MOODS_EMOJI[d.agent?.mood]);if(d.agent){currentAgent.mood=d.agent.mood;currentAgent.bond=d.agent.bond;currentAgent.energy=d.agent.energy;currentAgent.karma=d.agent.karma;currentAgent.streak=d.agent.streak;}if(d.ritualsDone)appendChat('agent','üåü –í—Å–µ 3 —Ä–∏—Ç—É–∞–ª–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã! –ö–∞—Ä–º–∞ +25.','inspired','inspired','‚ú®');}catch(e){removeTyping();}}

async function loadEmotions(){if(!currentAgent)return;try{const r=await fetch(`${API}/api/agents/${currentAgent.id}/emotions`);const d=await r.json();renderEmotionMap(d.emotionHistory||[],d.karma);}catch(e){}}
function renderEmotionMap(history,karma){const el=document.getElementById('emo-map');if(!el)return;el.innerHTML=history.length===0?'<span style="color:var(--muted);font-size:13px">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</span>':history.slice(-30).map(e=>`<div class="emo-dot ${EMO_CLASS[e.emotion]||'emo-neutral'}" title="${e.emotion}">${EMO_MAP[e.emotion]||'‚ö™'}</div>`).join('');const kEl=document.getElementById('karma-display');if(kEl){const k=karma||0;kEl.className='karma-val '+(k>0?'karma-pos':k<0?'karma-neg':'karma-neutral');kEl.textContent=(k>=0?'+':'')+k+' –∫–∞—Ä–º–∞';}}
async function loadMemory(){if(!currentAgent)return;try{const r=await fetch(`${API}/api/agents/${currentAgent.id}/memory`);const d=await r.json();const el=document.getElementById('memory-log');if(!el)return;const last=(d.memory||[]).slice(-10);if(!last.length){el.innerHTML='<div style="color:var(--muted);font-size:13px">–ü–∞–º—è—Ç—å –ø—É—Å—Ç–∞</div>';return;}el.innerHTML=last.reverse().map(m=>{const t=new Date(m.ts).toLocaleTimeString('ru',{hour:'2-digit',minute:'2-digit'});const rc=`mem-role-${m.role}`;const rl=m.role==='user'?'–¢—ã':m.role==='reflection'?'‚ú® –†–µ—Ñ–ª–µ–∫—Å–∏—è':'–ê–≥–µ–Ω—Ç';return `<div class="mem-entry"><span class="${rc}">${rl}</span>: <span class="mem-text">${m.text}</span><div class="mem-time">${t}${m.emotion&&m.emotion!=='neutral'?' ¬∑ '+m.emotion:''}</div></div>`;}).join('');}catch(e){}}
async function updateStatsTab(){await loadEmotions();await loadMemory();}
async function submitReflect(){if(!currentAgent)return;const input=document.getElementById('reflect-input');const text=input.value.trim();try{const r=await fetch(`${API}/api/agents/${currentAgent.id}/ritual/reflect`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({reflection:text})});const d=await r.json();if(d.error){alert(d.error);return;}input.value='';const form=document.getElementById('reflect-form');form.innerHTML=`<div style="text-align:center;padding:12px;color:#00D2FF">${d.message}</div>`;if(d.agentResponse)form.innerHTML+=`<div class="dq-card" style="margin-top:8px">${d.agentResponse}</div>`;if(currentAgent)currentAgent.rituals={...(currentAgent.rituals||{}),reflect:true};renderCare();updateStatsTab();}catch(e){}}

function buildArchGrid(){const grid=document.getElementById('arch-grid');if(!grid)return;grid.innerHTML=Object.entries(ARCHETYPES).map(([k,v])=>`<div class="arch-btn ${k===newArchetype?'selected':''}" onclick="selectArch('${k}')" style="border-color:${k===newArchetype?v.color:'#1e1e32'}">${v.emoji} ${v.name}</div>`).join('');}
function selectArch(key){newArchetype=key;buildArchGrid();}
async function createAgent(){const name=document.getElementById('new-agent-name').value.trim();try{const r=await fetch(`${API}/api/agents`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({archetype:newArchetype,name:name||undefined})});const agent=await r.json();if(agent.error){alert(agent.error);return;}document.getElementById('new-agent-name').value='';await loadAgents();selectAgent(agent);}catch(e){}}
function renderCrossbreed(){const sec=document.getElementById('crossbreed-section');if(!sec)return;if(agents.length<2){sec.style.display='none';return;}sec.style.display='block';const sel=document.getElementById('crossbreed-selects');const opts=agents.map(a=>`<option value="${a.id}">${ARCHETYPES[a.archetype]?.emoji} ${a.name} Lv.${a.level}</option>`).join('');sel.innerHTML=`<div style="display:flex;gap:8px"><select id="cb-a1" style="flex:1;background:var(--bg3);border:1px solid #1e1e32;border-radius:10px;padding:8px;color:var(--text)">${opts}</select><select id="cb-a2" style="flex:1;background:var(--bg3);border:1px solid #1e1e32;border-radius:10px;padding:8px;color:var(--text)">${opts}</select></div>`;const opts2=sel.querySelectorAll('select');if(opts2[1]&&agents.length>1)opts2[1].value=agents[1].id;}
async function doCrossbreed(){const a1=document.getElementById('cb-a1')?.value;const a2=document.getElementById('cb-a2')?.value;if(!a1||!a2||a1===a2){alert('–í—ã–±–µ—Ä–∏ –¥–≤—É—Ö —Ä–∞–∑–Ω—ã—Ö –∞–≥–µ–Ω—Ç–æ–≤');return;}try{const r=await fetch(`${API}/api/agents/crossbreed`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({agent1:a1,agent2:a2})});const child=await r.json();if(child.error){alert(child.error);return;}await loadAgents();selectAgent(child);}catch(e){}}

function switchTab(name){document.querySelectorAll('.tab-content').forEach(el=>el.classList.remove('active'));document.querySelectorAll('.tab').forEach(el=>el.classList.remove('active'));document.getElementById(`tab-${name}`).classList.add('active');document.querySelector(`[data-tab="${name}"]`).classList.add('active');if(name==='stats')updateStatsTab();if(name==='chat'&&currentAgent)loadDailyQuestion();}

init();
</script>
</body>
</html>